<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="StudReport">
	<select id="getYymm" parameterType="hashMap" resultType="resultMap">
		select
			yyyymm_key
		from sc_dsb.vw_dm_wk_dt
		where ((now() + interval '5.5 HOUR') - interval '1 MONTH')::DATE
				between stt_wk_dt and end_wk_dt;
    </select>
	
	<select id="getYymmwk" parameterType="hashMap" resultType="resultMap">
		select
			yyyymm_key,
			w::integer as wk
		from sc_dsb.vw_dm_wk_dt
		where ((now() + interval '5.5 HOUR') - interval '7 DAY')::DATE
				between stt_wk_dt and end_wk_dt;
    </select>
    
    <select id="getYymmwkList" parameterType="hashMap" resultType="resultMap">
		select
			yyyy_key as yyyy,
			substring(yyyymm_key::text,5,6)::integer as mm,
			w::integer as wk
		from sc_dsb.vw_dm_wk_dt
		where yyyymmw_key between (
			select
				wk.yyyymmw_key
			from lrndmt.mt_dm_stud st
			join sc_dsb.vw_dm_wk_dt wk on st.stt_dt between stt_wk_dt and end_wk_dt
			where st.stud_key = #{studId}
		) and (
			select
				yyyymmw_key
			from sc_dsb.vw_dm_wk_dt
			where ((now() + interval '5.5 HOUR') - interval '7 DAY')::DATE
					between stt_wk_dt and end_wk_dt
		);
    </select>
    
    <select id="getStudInfo" parameterType="hashMap" resultType="resultMap">
		select 
			pkg_typ,
			stt_dt,
			end_dt
		from lrndmt.mt_dm_stud 
		where stud_key = #{studId};
    </select>
    
    <select id="getStudRecentReport" parameterType="hashMap" resultType="resultMap">
		select
			recent_report
		from (
			select
				recent_report,
				yymm_check
			from (
				select
					yyyymm_key as recent_report,
					concat(yyyymm_key,'9')::integer as yymm_check
				from lrn_dsb.ds_ag_stud_att_sts_mly 
				where stud_key = #{studId} and ssvc_akey = 3
				order by yyyymm_key desc
				limit 1
			) mm
			union all
			select 
				recent_report,
				yymm_check
			from (
				select
					yyyymmw_key as recent_report,
					yyyymmw_key as yymm_check
				from lrn_dsb.ds_ag_stud_att_sts_wly
				where stud_key = #{studId} and ssvc_akey = 3
				order by yyyymmw_key desc
				limit 1
			) wk
		) rem
		order by yymm_check desc
		limit 1;
    </select>
	
	<select id="getPeriod" parameterType="hashMap" resultType="resultMap">
		<choose>
			<when test='currConCheck == "m"'>
				select
					min(yyyymm_key) as start_yymm,
					max(yyyymm_key) as end_yymm
				from (
					select 
						yyyymm_key
					from lrndmt.mt_dm_wk_dt a
					where yyyymm_key<![CDATA[<=]]>#{yymm}
						and w = '1'
					order by yyyymm_key desc
					limit 5
				) a1;
			</when>
			<otherwise>
				select
					min(yyyymmw_key) as start_yymmwk,
					max(yyyymmw_key) as end_yymmwk
				from (
					select 
						yyyymmw_key
					from lrndmt.mt_dm_wk_dt a
					where yyyymmw_key<![CDATA[<=]]>#{yymmwk}
					order by yyyymmw_key desc
					limit 5
				) a1;
			</otherwise>
		</choose>
    </select>
	
	<select id="getReportYymmList" parameterType="hashMap" resultType="resultMap">
		select
			distinct
				yyyymm_key as yymm,
				yyyy_key as yyyy,
				substring(yyyymm_key::text,5,6)::integer as mm
		from sc_dsb.vw_dm_wk_dt
		where yyyymmw_key between (
			select
				wk.yyyymmw_key
			from lrndmt.mt_dm_stud st
			join sc_dsb.vw_dm_wk_dt wk on st.stt_dt between stt_wk_dt and end_wk_dt
			where st.stud_key = #{studId}
		) and (
			select
				yyyymmw_key
			from sc_dsb.vw_dm_wk_dt
			where ((now() + interval '5.5 HOUR') - interval '7 DAY')::DATE
					between stt_wk_dt and end_wk_dt
		);
    </select>
    
    <select id="getMonthReportList" parameterType="hashMap" resultType="resultMap">
    	select
			dm.yyyymm_key as month_report_yymm,
			replace('mm월 월간 리포트','mm',mm::text) as report_nm,
			case 
				when mp.stud_key is null then 'N'
				else 'Y'
			end as report_yn
		from (
			select
				distinct
					yyyymm_key,
					substring(yyyymm_key::text,5,6)::integer as mm,
					cast(#{studId} as integer) as stud_key
			from lrndmt.mt_dm_wk_dt
			where yyyymm_key between (
				select
					wk.yyyymm_key as start_yymm
				from lrndmt.mt_dm_stud st
				join sc_dsb.vw_dm_wk_dt wk on st.stt_dt between stt_wk_dt and end_wk_dt
				where st.stud_key = #{studId}
			) and cast(to_char(cast(now() - interval '1 month' as DATE), 'YYYYmm') as integer)
		) dm
		left outer join lrn_dsb.ds_ag_stud_att_sts_mly mp on dm.yyyymm_key = mp.yyyymm_key and dm.stud_key = mp.stud_key and mp.ssvc_akey = 3;
    </select>
    
    <select id="getWeeklyReportList" parameterType="hashMap" resultType="resultMap">
    	select
			wm.yyyymm_key as week_report_yymm,
			wm.yyyymmw_key as week_report_yymmwk,
			replace(replace('mm월 wk주 주간 리포트','mm',mm::text),'wk',wk::text) as report_nm,
			case 
				when wp.stud_key is null then 'N'
				else 'Y'
			end as report_yn
		from (
			select
				distinct
					yyyymm_key,
					yyyymmw_key,
					substring(yyyymm_key::text,5,6)::integer as mm,
					w::integer as wk,
					cast(#{studId} as integer) as stud_key
			from lrndmt.mt_dm_wk_dt
			where yyyymmw_key between (
				select
					wk.yyyymmw_key
				from lrndmt.mt_dm_stud st
				join sc_dsb.vw_dm_wk_dt wk on st.stt_dt between stt_wk_dt and end_wk_dt
				where st.stud_key = #{studId}
			) and (
				select
					yyyymmw_key
				from sc_dsb.vw_dm_wk_dt
				where ((now() + interval '5.5 HOUR') - interval '7 DAY')::DATE
						between stt_wk_dt and end_wk_dt
			)
		) wm
		left outer join lrn_dsb.ds_ag_stud_att_sts_wly wp on wm.yyyymmw_key = wp.yyyymmw_key and wm.stud_key = wp.stud_key and wp.ssvc_akey = 3
		order by wm.yyyymmw_key desc;
    </select>

    <select id="getLrnSummary" parameterType="hashMap" resultType="resultMap">
    	select
    		-- round(c.att_rt * 100) as att_rt,
   		<choose>
			<when test='currConCheck == "m"'>
			round(c.att_dd * 100 / (select max(dd)from lrndmt.st_dm_dt where yyyymm_key = c.yyyymm_key)::integer)::integer as att_rt,
			(select max(dd) from lrndmt.st_dm_dt where yyyymm_key = c.yyyymm_key) as att_dt_cnt,
			</when>
			<otherwise>
			round(c.att_dd * 100 / 7 )::integer as att_rt,
			7 as att_dt_cnt,
			</otherwise>
		</choose>
    		c.att_dd as att_cnt,
			plan_lrn_cnt as plan_cnt,
			lrn_exec_cnt as lrn_cnt,
			round(exec_rt * 100) as ex_rt,
			pre_lrn_exec_cnt as b_lrn_cnt,
			intm_lrn_exec_cnt as t_lrn_cnt,
			dely_lrn_exec_cnt as d_lrn_cnt,
			round(pre_lrn_exec_cnt * 100 / lrn_exec_cnt)::integer as b_lrn_rt,
			round(intm_lrn_exec_cnt * 100 / lrn_exec_cnt)::integer as t_lrn_rt,
			round(dely_lrn_exec_cnt * 100 / lrn_exec_cnt)::integer as d_lrn_rt,
			null as concn_score,
			null as concn_msg,
			-- b.tot_lrn_cnt as lrn_sec,
			a.add_lrn_cnt as a_lrn_cnt
		<choose>
			<when test='currConCheck == "m"'>
			from lrn_dsb.ds_ag_lrn_use_sts_mly a
			left outer join lrn_dsb.ds_ag_lrn_plan_exec_sts_mly b on a.yyyymm_key = b.yyyymm_key and a.stud_key = b.stud_key and a.ssvc_akey = b.ssvc_akey and a.grp_item_key = b.grp_item_key 
			left outer join lrn_dsb.ds_ag_stud_att_sts_mly c on a.yyyymm_key = c.yyyymm_key and a.stud_key = c.stud_key and a.ssvc_akey = c.ssvc_akey 
			where a.yyyymm_key = #{yymm}
			</when>
			<otherwise>
			from lrn_dsb.ds_ag_lrn_use_sts_wly a
			left outer join lrn_dsb.ds_ag_lrn_plan_exec_sts_wly b on a.yyyymmw_key = b.yyyymmw_key and a.stud_key = b.stud_key and a.ssvc_akey = b.ssvc_akey and a.grp_item_key = b.grp_item_key 
			left outer join lrn_dsb.ds_ag_stud_att_sts_wly c on a.yyyymmw_key = c.yyyymmw_key and a.stud_key = c.stud_key and a.ssvc_akey = c.ssvc_akey 
			where a.yyyymmw_key = #{yymmwk}
			</otherwise>
		</choose>
			and a.stud_key = #{studId}
			and a.ssvc_akey = 3
			and a.grp_item_key = 3;
    </select>
    
    <select id="getExamSubjSummary" parameterType="hashMap" resultType="resultMap">
    	select
			case
				when b.grp_item_key = 3 then 'c00'
				else replace(b.item_cd,'A','c')
			end as subj_cd,
			round(answ_rt * 100) as ex_rt
		<choose>
			<when test='currConCheck == "m"'>
			from lrn_dsb.ds_ag_exam_assm_sts_mly a
			join lrn_dsb.ds_dm_grp_item b on a.grp_item_key = b.grp_item_key
			where a.yyyymm_key = #{yymm}
			</when>
			<otherwise>
			from lrn_dsb.ds_ag_exam_assm_sts_wly a
			join lrn_dsb.ds_dm_grp_item b on a.grp_item_key = b.grp_item_key
			where a.yyyymmw_key = #{yymmwk}
			</otherwise>
		</choose>
			and a.stud_key = #{studId}
			and a.ssvc_akey = 3
			and a.exam_typ_key = 0;
    </select>
    
    <select id="getExamQuesSummary" parameterType="hashMap" resultType="resultMap">
    	select
			round(a.answ_rt * 100) as exam_score,
			c.wnote_tot_cnt,
			c.wnote_unfnsh_cnt,
			b.ques_tot_cnt,
			b.ques_skip_cnt,
			b.ques_hrry_cnt,
			b.ques_guss_cnt,
			b.ques_mstke_cnt
		<choose>
			<when test='currConCheck == "m"'>
			from lrn_dsb.ds_ag_exam_assm_sts_mly a
			left outer join lrn_dsb.ds_ag_exam_slv_habit_sts_mly b on a.yyyymm_key = b.yyyymm_key and a.stud_key = b.stud_key 
				and a.ssvc_akey = b.ssvc_akey and a.exam_typ_key = b.exam_typ_key and a.grp_item_key = b.grp_item_key
			left outer join lrn_dsb.ds_ag_exam_wnote_sts_mly c on a.yyyymm_key = c.yyyymm_key and a.stud_key = c.stud_key 
				and a.ssvc_akey = c.ssvc_akey and a.exam_typ_key = c.exam_typ_key and a.grp_item_key = c.grp_item_key
			where a.yyyymm_key = #{yymm}
			</when>
			<otherwise>
			from lrn_dsb.ds_ag_exam_assm_sts_wly a
			left outer join lrn_dsb.ds_ag_exam_slv_habit_sts_wly b on a.yyyymmw_key = b.yyyymmw_key and a.stud_key = b.stud_key 
				and a.ssvc_akey = b.ssvc_akey and a.exam_typ_key = b.exam_typ_key and a.grp_item_key = b.grp_item_key
			left outer join lrn_dsb.ds_ag_exam_wnote_sts_wly c on a.yyyymmw_key = c.yyyymmw_key and a.stud_key = c.stud_key 
				and a.ssvc_akey = c.ssvc_akey and a.exam_typ_key = c.exam_typ_key and a.grp_item_key = c.grp_item_key
			where a.yyyymmw_key = #{yymmwk}
			</otherwise>
		</choose>
			and a.stud_key = #{studId}
			and a.ssvc_akey = 3
			and a.exam_typ_key = 0
			and a.grp_item_key = 3;
    </select>
    
    <select id="getLrnStt" parameterType="hashMap" resultType="resultMap">
    	select
			count(case when plan_lrn_cnt > 0 then plan_lrn_cnt else null end) as plan_dt_cnt,
			count(case when plan_lrn_fnsh_yn then lrn_exec_cnt else null end) as fnsh_dt_cnt,
			sum(plan_lrn_cnt) as plan_cnt,
			sum(lrn_exec_cnt) as fnsh_cnt
		from lrn_dsb.ds_ag_lrn_plan_exec_sts_dly a
		<choose>
			<when test='currConCheck == "m"'>
			join lrndmt.mt_dm_dt b on a.dt_key = b.dt_key and b.yyyymm_key = #{yymm}
			</when>
			<otherwise>
			join lrndmt.mt_dm_dt b on a.dt_key = b.dt_key and b.yyyymmw_key = #{yymmwk} 
			</otherwise>
		</choose>
			and a.stud_key = #{studId}
			and a.ssvc_akey = 3
			and a.grp_item_key = 3;
    </select>
    
    <select id="getLrnSttList" parameterType="hashMap" resultType="resultMap">
    	select
			a.dt,
			a.day_ko,
			b.plan_lrn_cnt,
			b.lrn_exec_cnt
		<choose>
			<when test='currConCheck == "m"'>
			from lrndmt.mt_dm_dt a
			left outer join lrn_dsb.ds_ag_lrn_plan_exec_sts_dly b on a.dt_key = b.dt_key and b.stud_key = #{studId} and b.ssvc_akey = 3 and b.grp_item_key = 3
			where a.yyyymm_key = #{yymm};
			</when>
			<otherwise>
			from lrndmt.mt_dm_dt a
			left outer join lrn_dsb.ds_ag_lrn_plan_exec_sts_dly b on a.dt_key = b.dt_key and b.stud_key = #{studId} and b.ssvc_akey = 3 and b.grp_item_key = 3
			where a.yyyymmw_key = #{yymmwk};
			</otherwise>
		</choose>
    </select>
    
    <select id="getSubjLrnExRt" parameterType="hashMap" resultType="resultMap">
		<choose>
			<when test='currConCheck == "m"'>
			select
				distinct
					a.yyyymm_key,
					a.subj_cd,
					b.ex_rt
			from (
				select
					a.yyyymm_key,
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(b.item_cd,'A','C')
					end as subj_cd
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_dm_grp_item b on (b.grp_typ = 'ALL' or b.grp_typ = 'SUBJ_CD') and ( position('#' in b.item_cd) = 0 and position('N' in b.item_cd) = 0)
				where a.yyyymm_key between #{startYymm} and #{endYymm}
					and a.w = '1'
			) a
			left outer join (
				select 
					a.yyyymm_key, 
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(c.item_cd,'A','C')
					end as subj_cd,
					round(b.exec_rt * 100) as ex_rt
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_ag_lrn_plan_exec_sts_mly b on a.yyyymm_key = b.yyyymm_key and b.stud_key = #{studId} and b.ssvc_akey = 3
				join lrn_dsb.ds_dm_grp_item c on b.grp_item_key = c.grp_item_key and (c.grp_typ = 'ALL' or c.grp_typ = 'SUBJ_CD') and position('#' in c.item_cd) = 0
				where a.yyyymm_key between #{startYymm} and #{endYymm}
					and a.w = '1'
			) b on a.yyyymm_key = b.yyyymm_key and a.subj_cd = b.subj_cd
			order by a.subj_cd, a.yyyymm_key;
			</when>
			<otherwise>
			select
				distinct
					a.yyyymmw_key,
					a.subj_cd,
					b.ex_rt
			from (
				select
					a.yyyymmw_key,
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(b.item_cd,'A','C')
					end as subj_cd
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_dm_grp_item b on (b.grp_typ = 'ALL' or b.grp_typ = 'SUBJ_CD') and ( position('#' in b.item_cd) = 0 and position('N' in b.item_cd) = 0)
				where a.yyyymmw_key between #{startYymmwk} and #{endYymmwk}
			) a
			left outer join (
				select 
					a.yyyymmw_key, 
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(c.item_cd,'A','C')
					end as subj_cd,
					round(b.exec_rt * 100) as ex_rt
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_ag_lrn_plan_exec_sts_wly b on a.yyyymmw_key = b.yyyymmw_key and b.stud_key = #{studId} and b.ssvc_akey = 3
				join lrn_dsb.ds_dm_grp_item c on b.grp_item_key = c.grp_item_key and (c.grp_typ = 'ALL' or c.grp_typ = 'SUBJ_CD') and position('#' in c.item_cd) = 0
				where a.yyyymmw_key between #{startYymmwk} and #{endYymmwk}
			) b on a.yyyymmw_key = b.yyyymmw_key and a.subj_cd = b.subj_cd
			order by a.subj_cd, a.yyyymmw_key;
			</otherwise>
		</choose>
    </select>
    
    <select id="getLrnHabit" parameterType="hashMap" resultType="resultMap">
    	select 
			case
				when intm_lrn_exec_cnt = greatest(intm_lrn_exec_cnt, intm_lrn_exec_cnt, dely_lrn_exec_cnt) then 'tLrn'
				when pre_lrn_exec_cnt = greatest(intm_lrn_exec_cnt, intm_lrn_exec_cnt, dely_lrn_exec_cnt) then 'bLrn'
				when dely_lrn_exec_cnt = greatest(intm_lrn_exec_cnt, intm_lrn_exec_cnt, dely_lrn_exec_cnt) then 'dLrn'
				else null
			end as max_nm
		<choose>
			<when test='currConCheck == "m"'>
			from lrn_dsb.ds_ag_lrn_plan_exec_sts_mly 
			where yyyymm_key = #{yymm}
			</when>
			<otherwise>
			from lrn_dsb.ds_ag_lrn_plan_exec_sts_wly 
			where yyyymmw_key = #{yymmwk} 
			</otherwise>
		</choose>
			and stud_key = #{studId} 
			and ssvc_akey = 3
			and grp_item_key = 3;
    </select>
    
    <select id="getSubjLrnTm" parameterType="hashMap" resultType="resultMap">
		<choose>
			<when test='currConCheck == "m"'>
			select
				distinct
					a.yyyymm_key,
					a.subj_cd,
					b.tot_lrn_ss as lrn_sec
			from (
				select
					a.yyyymm_key,
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(b.item_cd,'A','C')
					end as subj_cd
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_dm_grp_item b on (b.grp_typ = 'ALL' or b.grp_typ = 'SUBJ_CD') and ( position('#' in b.item_cd) = 0 and position('N' in b.item_cd) = 0)
				where a.yyyymm_key between #{startYymm} and #{endYymm}
					and a.w = '1'
			) a
			left outer join (
				select 
					a.yyyymm_key, 
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(c.item_cd,'A','C')
					end as subj_cd,
					tot_lrn_ss
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_ag_lrn_use_sts_mly b on a.yyyymm_key = b.yyyymm_key and b.stud_key = #{studId} and b.ssvc_akey = 3
				join lrn_dsb.ds_dm_grp_item c on b.grp_item_key = c.grp_item_key and (c.grp_typ = 'ALL' or c.grp_typ = 'SUBJ_CD') and position('#' in c.item_cd) = 0
				where a.yyyymm_key between #{startYymm} and #{endYymm}
					and a.w = '1'
			) b on a.yyyymm_key = b.yyyymm_key and a.subj_cd = b.subj_cd
			order by a.subj_cd, a.yyyymm_key;
			</when>
			<otherwise>
			select
				distinct
					a.yyyymmw_key,
					a.subj_cd,
					b.tot_lrn_ss as lrn_sec
			from (
				select
					a.yyyymmw_key,
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(b.item_cd,'A','C')
					end as subj_cd
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_dm_grp_item b on (b.grp_typ = 'ALL' or b.grp_typ = 'SUBJ_CD') and ( position('#' in b.item_cd) = 0 and position('N' in b.item_cd) = 0)
				where a.yyyymmw_key between #{startYymmwk} and #{endYymmwk}
			) a
			left outer join (
				select
					a.yyyymmw_key, 
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(c.item_cd,'A','C')
					end as subj_cd,
					tot_lrn_ss
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_ag_lrn_use_sts_wly b on a.yyyymmw_key = b.yyyymmw_key and b.stud_key = #{studId} and b.ssvc_akey = 3
				join lrn_dsb.ds_dm_grp_item c on b.grp_item_key = c.grp_item_key and (c.grp_typ = 'ALL' or c.grp_typ = 'SUBJ_CD') and position('#' in c.item_cd) = 0
				where a.yyyymmw_key between #{startYymmwk} and #{endYymmwk}
			) b on a.yyyymmw_key = b.yyyymmw_key and a.subj_cd = b.subj_cd
			order by a.subj_cd, a.yyyymmw_key;
			</otherwise>
		</choose>
    </select>
    
    <select id="getALrnStt" parameterType="hashMap" resultType="resultMap">
    	select
    		<choose>
				<when test="size != null">
				case
					when b.grp_item_key = 3 then 'C00'
					else replace(b.item_cd,'A','C')
				end as subj_cd,
				a.fnsh_add_lrn_cnt
				</when>
				<otherwise>
				b.subj_clss_nm as subj_nm
				</otherwise>
			</choose>
		from lrn_dsb.ds_ag_lrn_use_sts_mly a
		join lrn_dsb.ds_dm_grp_item b on a.grp_item_key = b.grp_item_key and b.grp_typ = 'SUBJ_CD' and position('#' in b.item_cd) = 0
		where a.yyyymm_key = #{yymm}
			and a.stud_key = #{studId} 
			and a.ssvc_akey = 3
		order by a.fnsh_add_lrn_cnt desc
		<choose>
			<when test="size != null">
			limit 3;
			</when>
			<otherwise>
			limit 1;
			</otherwise>
		</choose>
    </select>
    
    <select id="getSubjExamScore" parameterType="hashMap" resultType="resultMap">
		<choose>
			<when test='currConCheck == "m"'>
			select
				distinct
					a.yyyymm_key,
					a.subj_cd,
					b.ex_rt
			from (
				select
					a.yyyymm_key,
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(b.item_cd,'A','C')
					end as subj_cd
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_dm_grp_item b on (b.grp_typ = 'ALL' or b.grp_typ = 'SUBJ_CD') and ( position('#' in b.item_cd) = 0 and position('N' in b.item_cd) = 0)
				where a.yyyymm_key between #{startYymm} and #{endYymm}
					and a.w = '1'
			) a
			left outer join (
				select 
					a.yyyymm_key, 
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(c.item_cd,'A','C')
					end as subj_cd,
					round(b.answ_rt * 100) as ex_rt
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_ag_exam_assm_sts_mly b on a.yyyymm_key = b.yyyymm_key and b.stud_key = #{studId} and b.ssvc_akey = 3 and b.exam_typ_key = 0
				join lrn_dsb.ds_dm_grp_item c on b.grp_item_key = c.grp_item_key and (c.grp_typ = 'ALL' or c.grp_typ = 'SUBJ_CD') and position('#' in c.item_cd) = 0
				where a.yyyymm_key between #{startYymm} and #{endYymm}
					and a.w = '1'
			) b on a.yyyymm_key = b.yyyymm_key and a.subj_cd = b.subj_cd
			order by a.subj_cd, a.yyyymm_key;
			</when>
			<otherwise>
			select
				distinct
					a.yyyymmw_key,
					a.subj_cd,
					b.ex_rt
			from (
				select
					a.yyyymmw_key,
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(b.item_cd,'A','C')
					end as subj_cd
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_dm_grp_item b on (b.grp_typ = 'ALL' or b.grp_typ = 'SUBJ_CD') and ( position('#' in b.item_cd) = 0 and position('N' in b.item_cd) = 0)
				where a.yyyymmw_key between #{startYymmwk} and #{endYymmwk}
			) a
			left outer join (
				select
					a.yyyymmw_key,
					case
						when b.grp_item_key = 3 then 'C00'
						else replace(c.item_cd,'A','C')
					end as subj_cd,
					round(b.answ_rt * 100) as ex_rt
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_ag_exam_assm_sts_wly b on a.yyyymmw_key = b.yyyymmw_key and b.stud_key = #{studId} and b.ssvc_akey = 3 and b.exam_typ_key = 0
				join lrn_dsb.ds_dm_grp_item c on b.grp_item_key = c.grp_item_key and (c.grp_typ = 'ALL' or c.grp_typ = 'SUBJ_CD') and position('#' in c.item_cd) = 0
				where a.yyyymmw_key between #{startYymmwk} and #{endYymmwk}
			) b on a.yyyymmw_key = b.yyyymmw_key and a.subj_cd = b.subj_cd
			order by a.subj_cd, a.yyyymmw_key;
			</otherwise>
		</choose>
    </select>
    
    <select id="getIncrtNoteStt" parameterType="hashMap" resultType="resultMap">
    	select 
			wnote_tot_cnt,
			wnote_fnsh_cnt,
			wnote_unfnsh_cnt,
			round(wnote_fnsh_cnt * 100 / wnote_tot_cnt)::integer as incrt_note_fnsh_rt,
			round(wnote_unfnsh_cnt * 100 / wnote_tot_cnt)::integer as incrt_note_nc_rt
		<choose>
			<when test='currConCheck == "m"'>
			from lrn_dsb.ds_ag_exam_wnote_sts_mly 
			where yyyymm_key = #{yymm}
			</when>
			<otherwise>
			from lrn_dsb.ds_ag_exam_wnote_sts_wly
			where yyyymmw_key = #{yymmwk} 
			</otherwise>
		</choose>
			and stud_key = #{studId}
			and ssvc_akey = 3
			and exam_typ_key = 3
			and grp_item_key = 3;
    </select>
    
    <select id="getSlvHabitStt" parameterType="hashMap" resultType="resultMap">
		<choose>
			<when test='currConCheck == "m"'>
			select
				distinct
					a.yyyymm_key,
					b.ques_skip_cnt,
					b.ques_hrry_cnt,
					b.ques_guss_cnt,
					b.ques_mstke_cnt
			from (
				select
					a.yyyymm_key
				from lrndmt.mt_dm_wk_dt a
				where a.yyyymm_key between #{startYymm} and #{endYymm}
					and a.w = '1'
			) a
			left outer join (
				select 
					a.yyyymm_key,
					b.ques_skip_cnt,
					b.ques_hrry_cnt,
					b.ques_guss_cnt,
					b.ques_mstke_cnt
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_ag_exam_slv_habit_sts_mly b on a.yyyymm_key = b.yyyymm_key and b.stud_key = #{studId} and b.ssvc_akey = 3 and b.exam_typ_key = 0 and b.grp_item_key = 3
				where a.yyyymm_key between #{startYymm} and #{endYymm}
					and a.w = '1'
			) b on a.yyyymm_key = b.yyyymm_key
			order by a.yyyymm_key;
			</when>
			<otherwise>
			select
				distinct
					a.yyyymmw_key,
					b.ques_skip_cnt,
					b.ques_hrry_cnt,
					b.ques_guss_cnt,
					b.ques_mstke_cnt
			from (
				select
					a.yyyymmw_key
				from lrndmt.mt_dm_wk_dt a
				where a.yyyymmw_key between #{startYymmwk} and #{endYymmwk}
			) a
			left outer join (
				select 
					a.yyyymmw_key,
					b.ques_skip_cnt,
					b.ques_hrry_cnt,
					b.ques_guss_cnt,
					b.ques_mstke_cnt
				from lrndmt.mt_dm_wk_dt a
				left outer join lrn_dsb.ds_ag_exam_slv_habit_sts_wly b on a.yyyymmw_key = b.yyyymmw_key and b.stud_key = #{studId} and b.ssvc_akey = 3 and b.exam_typ_key = 0 and b.grp_item_key = 3
				where a.yyyymmw_key between #{startYymmwk} and #{endYymmwk}
			) b on a.yyyymmw_key = b.yyyymmw_key
			order by a.yyyymmw_key;
			</otherwise>
		</choose>
    </select>
    
</mapper>
