<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Group_1.0">

    <select id="selectPeriodWeeks" parameterType="hashMap" resultType="resultMap">
	/* selectPeriodWeeks : 년월, 주차 산출 - 기간정보 */
		SELECT 
			CAST(SUBSTRING(YYMM,1,4) AS SIGNED INTEGER) AS YEAR,
			CAST(SUBSTRING(YYMM,5,2) AS SIGNED INTEGER) AS MONTH,		
			CAST(WK AS SIGNED INTEGER) AS WEEK,
			CONCAT(IF(#{svcOpenDe} <![CDATA[>]]> IFNULL(MO, IFNULL(TU, IFNULL(WE, IFNULL(TH, IFNULL(FR, IFNULL(SA, SU)))))), DATE_FORMAT(STR_TO_DATE(#{svcOpenDe}, '%Y-%m-%d'), '%Y.%m.%d'), DATE_FORMAT(IFNULL(MO, IFNULL(TU, IFNULL(WE, IFNULL(TH, IFNULL(FR, IFNULL(SA, SU)))))), '%Y.%m.%d')),'-',DATE_FORMAT(IFNULL(SU, IFNULL(SA, IFNULL(FR, IFNULL(TH, IFNULL(WE, IFNULL(TU, MO)))))), '%Y.%m.%d')) AS DTSTRA
		FROM COMM_WK_DT
		WHERE IFNULL(SU, IFNULL(SA, IFNULL(FR, IFNULL(TH, IFNULL(WE, IFNULL(TU, MO)))))) <![CDATA[>=]]> DATE_FORMAT(#{svcOpenDe}, '%Y-%m-%d')
			AND IFNULL(SU, IFNULL(SA, IFNULL(FR, IFNULL(TH, IFNULL(WE, IFNULL(TU, MO)))))) <![CDATA[<]]> DATE_FORMAT(now() + INTERVAL 3 HOUR , '%Y-%m-%d')
	</select>
	
	<select id="selectPeriodMonths" parameterType="hashMap" resultType="resultMap">
	/* selectPeriodMonths : 년월 산출 - 기간정보 */
		SELECT 
			CAST(SUBSTRING(A.YYMM,1,4) AS SIGNED INTEGER) AS YEAR,
			CAST(SUBSTRING(A.YYMM,5,2) AS SIGNED INTEGER) AS MONTH,
			CONCAT(IF(STR_TO_DATE(#{svcOpenDe}, '%Y-%m-%d') <![CDATA[>]]> IFNULL(MO, IFNULL(TU, IFNULL(WE, IFNULL(TH, IFNULL(FR, IFNULL(SA, SU))))))
						,DATE_FORMAT(STR_TO_DATE(#{svcOpenDe}, '%Y-%m-%d'), '%Y.%m.%d')
						, DATE_FORMAT(IFNULL(MO, IFNULL(TU, IFNULL(WE, IFNULL(TH, IFNULL(FR, IFNULL(SA, SU)))))), '%Y.%m.%d'))
					,'-',
					DATE_FORMAT(LAST_DAY(IFNULL(MO, IFNULL(TU, IFNULL(WE, IFNULL(TH, IFNULL(FR, IFNULL(SA, SU))))))), '%Y.%m.%d')) AS DTSTRA
		FROM COMM_WK_DT A 
		JOIN (
			SELECT
				SUBSTRING_INDEX(GROUP_CONCAT(YYMM SEPARATOR '|'),'|', 1) AS START_YYMM,
		        SUBSTRING_INDEX(GROUP_CONCAT(YYMM SEPARATOR '|'),'|', -1) AS END_YYMM
			FROM COMM_WK_DT
			WHERE ( 
					DATE_FORMAT(#{svcOpenDe}, '%Y-%m-%d')
					BETWEEN IFNULL(MO, IFNULL(TU, IFNULL(WE, IFNULL(TH, IFNULL(FR, IFNULL(SA, SU))))))
						and IFNULL(SU, IFNULL(SA, IFNULL(FR, IFNULL(TH, IFNULL(WE, IFNULL(TU, MO)))))) 
				)
				OR (
					DATE_FORMAT(NOW() + INTERVAL 3 HOUR , '%Y-%m-%d')
					BETWEEN IFNULL(MO, IFNULL(TU, IFNULL(WE, IFNULL(TH, IFNULL(FR, IFNULL(SA, SU))))))
						and IFNULL(SU, IFNULL(SA, IFNULL(FR, IFNULL(TH, IFNULL(WE, IFNULL(TU, MO))))))
				)
		) B ON A.YYMM <![CDATA[>=]]> B.START_YYMM 
			AND A.YYMM <![CDATA[<]]> B.END_YYMM
		GROUP BY YYMM
	</select>
    
    <select id="selectStud" parameterType="hashMap" resultType="resultMap">
    /* selectStud : 학습분석 메인 - 학생 정보 */
	    SELECT studNm, gender, studId, loginId, grade, schlNm,
			IFNULL(TIMESTAMPDIFF(DAY, lastLoginDt,now()),-1) AS daysAgo,
			DATE_FORMAT(lastLoginDt,'%Y.%m.%d') AS lastLoginDt,
			DATE_FORMAT(lrnStartDt,'%Y.%m.%d') AS lrnStartDt
			FROM (
					SELECT 
						A.STUD_NM AS studNm,
						A.GENDER,
						A.STUD_ID AS studId,
						A.LOGIN_ID AS loginId,
						A.GRADE,
						A.SCHL_NM AS schlNm,
						MAX(B.DT) AS lastLoginDt, 
						B.FIRST_LOGIN_DTTM AS lrnStartDt
					FROM STUD A LEFT JOIN DAY_ATT_LOG B ON A.STUD_ID = B.STUD_ID AND B.LOGIN_YN = 'Y'  AND B.DT >= (NOW() - INTERVAL 7 DAY)
					WHERE A.STUD_ID = #{studId}
			) S	    
    </select>
    
    <select id="selectLrnBasicPeriod" parameterType="hashMap" resultType="resultMap">
	/* selectLrnBasicPeriod : 기관용 기간별 학습 분석 */
	
	</select>
	
	<select id="selectLrnBasicMonthly" parameterType="hashMap" resultType="resultMap">
	/* selectLrnBasicMonthly : 기관용 월간 학습 분석 */
	
	</select>
    
    <select id="getOrgEnvConfig" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="setOrgEnvConfig" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getLrnHabitChart" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getAiRecommendLrn" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getDiagnsticEvalStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getAttRtStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getLrnTmList" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getLrnDetail" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getAttCntStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getloginPtnStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getExRtStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getFnshLrnExStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getLrnExSttCompareSub" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getALrnExStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getCrtRtStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getIncrtNoteNcStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getCrtQuesCntStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getSlvHabitStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getDayAvgLrnStt " parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getTotalLrnTmStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getLongLrnTmStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getSubjExam" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getCompareSub" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getExamChart" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getSubjExamList" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getIncrtNote" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getChapterStt" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getChapterLrn" parameterType="hashMap" resultType="resultMap">
    </select>
    
    <select id="getCommMsgCd" parameterType="hashMap" resultType="resultMap">
    </select>
    
</mapper>
