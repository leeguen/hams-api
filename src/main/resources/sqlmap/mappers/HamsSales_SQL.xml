<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="HamsSales">
	<select id="subjCodeInfo" parameterType="hashMap" resultType="resultMap">
	/* HamsSales.subjCodeInfo : 과목 코드 정보 */
		SELECT 
			CD AS SUBJ_CD,
		    CD_NM AS SUBJ_NM,
		    NULL AS UPPER_SUBJ_CD
		FROM COMM_CD
		WHERE 
			GRP = 'SUBJ'
			AND GRADE = 6
			AND LANG_CD = 'ko'
		    AND CD_TYPE = 'G'
		UNION ALL
		SELECT 
			CD AS SUBJ_CD,
		    CD_NM AS SUBJ_NM,
		    UPPER_CD AS UPPER_SUBJ_CD
		FROM COMM_SUB_CD
		WHERE 
			GRP = 'SUBJ'
			AND GRADE = 6
			AND LANG_CD = 'ko'
		    AND CD_TYPE = 'G'
	</select>
	
	<select id="selectStudInfo" parameterType="hashMap" resultType="resultMap">
	/* HamsSales.selectStudInfo : 학생 정보 */
		SELECT 
			STUD_ID,
			STUD_NM,
			GRADE,
			SCHL_NM,
			GENDER,
			TCHR_CHA_ID AS TCHR_ID,
			DATE_FORMAT(START_DT, '%Y-%m-%d') AS EXP_START_DT,
			DATE_FORMAT(END_DT, '%Y-%m-%d') AS EXP_END_DT
		FROM STUD
		WHERE 
			DT = #{dt}
		    AND STUD_ID = #{studId}
	</select>
	
	<select id="selectLoginLogList" parameterType="hashMap" resultType="resultMap">
	/* HamsSales.selectLoginLogList : 일별 출석 로그 전체*/
		SELECT
			DATE_FORMAT(DT, '%Y-%m-%d') AS DT,
			DATE_FORMAT(LOGIN_DTTM, '%Y-%m-%d %H:%i:%s') AS LOGIN_DTTM
		FROM DAY_ATT_LOG
		WHERE
			DT BETWEEN #{startDt} AND #{endDt}
		    AND STUD_ID = #{studId}
		ORDER BY ORD DESC
		LIMIT 10
	</select>
	
	<select id="selectLrnPtn" parameterType="hashMap" resultType="resultMap">
	/* HamsSales.selectLrnPtn : 3일 리포트 학습 패턴*/
		SELECT 
			TOTAL_LRN_SEC
		FROM LRN_EX_DETAIL
		WHERE DT = #{dt}
			AND STUD_ID = #{studId}
	</select>
	
	<select id="selectLrnPtnTmln" parameterType="hashMap" resultType="resultMap">
	/* HamsSales.selectLrnPtnTmln : 3일 리포트 학습 패턴 - 타임라인*/
		SELECT 
			DATE_FORMAT(DT, '%Y.%m.%d') AS DT,
		    TIMESTAMPDIFF(DAY, START_DT, DT) + 1 AS EXP_DAY
		FROM STUD 
		WHERE DT BETWEEN #{dt} - INTERVAL 2 DAY  AND #{dt}
			AND STUD_ID = #{studId}
	</select>
	
	<select id="selectLrnTmln" parameterType="hashMap" resultType="resultMap">
	/* HamsSales.selectLrnTmln : 3일 리포트 학습 패턴 - 타임라인 상세*/
		SELECT 
			SUBJ_CD,
		    EX_TM,
		    LRN_NM,
		    LRN_SEC,
		    STD_LRN_SEC,
		    EX_TYPE,
		    DATE_FORMAT(PLAN_DT, '%Y.%m.%d' ) AS PLAN_DT
		FROM (
			SELECT 
				SUBJ_CD,
				CONCAT(DATE_FORMAT(IFNULL(LRN_START_DTTM,''), '%H:%i'), ' ~ ', DATE_FORMAT(IFNULL(LRN_END_DTTM,''), '%H:%i'))AS EX_TM,
				CTGR AS LRN_NM,
				LRN_SEC,
				600 AS STD_LRN_SEC,
				EX_TYPE_CD AS EX_TYPE,
				PLAN_DT
			FROM DAY_LRN_TMLN
			WHERE DT = #{dt}
				AND STUD_ID = #{studId}
			UNION ALL
			SELECT 
				NULL AS SUBJ_CD,
				NULL AS EX_TM,
				CTGR AS LRN_NM,
				NULL AS LRN_SEC,
				600 AS STD_LRN_SEC,
				2 AS EX_TYPE,
				PLAN_DT
			FROM DAY_PLAN_U_EX_STT
			WHERE DT = #{dt}
				AND STUD_ID = #{studId}
				AND LRN_EX_YN = 'N'
		)A
		<if test="ordNm != null and ordNm != ''">
			<choose>
				<when test="ordNm == 'planDt'">
					ORDER BY EX_TYPE
				</when>
				<otherwise>
					ORDER BY IFNULL(EX_TM,'23:59 ~ 24:00')
				</otherwise>
			</choose>
		</if>
	</select>
	
	<select id="selectLrnExStt" parameterType="hashMap" resultType="resultMap">
	/* HamsSales.selectLrnExStt : 3일 리포트 학습 수행 결과*/
		SELECT
			LRN_SUBJ_CD_SP,
			LRN_EX_CNT_SP,
			TOTAL_LRN_EX_CNT,
			GRP_LRN_EX_CNT
		FROM (
			SELECT 
				B.LRN_SUBJ_CD_SP,
			    B.LRN_EX_CNT_SP,
			    B.TOTAL_LRN_EX_CNT,
			    CASE
			    	WHEN B.LRN_SUBJ_CD_SP IS NULL THEN NULL
			    	ELSE C.TOTAL_LRN_EX_CNT
			    END AS GRP_LRN_EX_CNT
			FROM STUD A
			JOIN LRN_EX_DETAIL B ON A.DT = B.DT AND A.STUD_ID = B.STUD_ID
			JOIN LRN_EX_DETAIL_GRP C ON A.DT = C.DT AND A.GRADE = C.GRADE
			WHERE A.DT = #{dt}
				AND A.STUD_ID = #{studId}
		) A
	</select>
	
	<select id="selectLrnPlanStt" parameterType="hashMap" resultType="resultMap">
	/* HamsSales.selectLrnPlanStt : 3일 리포트 학습 수행 결과*/
		SELECT
			EX_RT,
			PLAN_CNT,
			EX_CNT,
		    GRP_AVG_EX_RT,
		    GRP_AVG_PLAN_CNT,
		    GRP_AVG_EX_CNT
		FROM (
			SELECT 
				B.PLAN_EX_RT AS EX_RT,
		        B.PLAN_CNT,
		        B.PLAN_EX_CNT AS EX_CNT,
		        CASE
					WHEN B.PLAN_CNT IS NULL THEN NULL
					ELSE C.PLAN_EX_RT
				END AS GRP_AVG_EX_RT,
		        CASE
					WHEN B.PLAN_CNT IS NULL THEN NULL
					ELSE C.PLAN_CNT
				END AS GRP_AVG_PLAN_CNT,
		        CASE
					WHEN B.PLAN_CNT IS NULL THEN NULL
					ELSE C.PLAN_EX_CNT
				END AS GRP_AVG_EX_CNT
			FROM STUD A
			JOIN LRN_EX_DETAIL B ON A.DT = B.DT AND A.STUD_ID = B.STUD_ID
			JOIN LRN_EX_DETAIL_GRP C ON A.DT = C.DT AND A.GRADE = C.GRADE
			WHERE A.DT = #{dt}
				AND A.STUD_ID = #{studId}
		) A
	</select>
	
	<select id="selectALrnStt" parameterType="hashMap" resultType="resultMap">
	/* HamsSales.selectALrnStt : 3일 리포트 학습 수행 결과*/
		SELECT
			A_LRN_SUBJ_CD_SP,
			A_LRN_EX_CNT_SP,
			A_LRN_EX_CNT,
			GRP_LRN_EX_CNT
		FROM (
			SELECT 
				B.A_LRN_SUBJ_CD_SP,
				B.A_LRN_EX_CNT_SP,
				B.A_LRN_EX_CNT,
				CASE
					WHEN B.LRN_SUBJ_CD_SP IS NULL THEN NULL
					ELSE C.A_LRN_EX_CNT
				END AS GRP_LRN_EX_CNT
			FROM STUD A
			JOIN LRN_EX_DETAIL B ON A.DT = B.DT AND A.STUD_ID = B.STUD_ID
			JOIN LRN_EX_DETAIL_GRP C ON A.DT = C.DT AND A.GRADE = C.GRADE
			WHERE A.DT = #{dt}
				AND A.STUD_ID = #{studId}
		) A
	</select>
	
</mapper>
