<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Homelog">

	<select id="selectHomelogPageCnt" parameterType="hashMap" resultType="resultMap">
		/* Homelog.selectHomelogPageCnt */
		SELECT
			COUNT(*) AS TOTAL_CNT,
		    CAST(CEIL((COUNT(*) / 10)) AS UNSIGNED) AS PAGE_CNT
		FROM STUD_MANUAL_HOMELOG
		WHERE STUD_ID = #{studId}
			AND YYYY = #{yyyy};
	</select>
	
	<select id="spTchrManualHomelogMaxCd" parameterType="hashMap" resultType="resultMap">
		/* Homelog.spTchrManualHomelogMaxCd */
		{call es_s_dashboard.tchr_hoemlog_max_cd (
			  #{tchrId, mode=IN, jdbcType=INTEGER},
			  #{yymm, mode=IN, jdbcType=INTEGER}
		 )}
	</select>
	
	<select id="selectHomelogMaxCd" parameterType="hashMap" resultType="resultMap">
		/* Homelog.selectHomelogMaxCd */
		SELECT
			COUNT(*) AS CNT,
			MAX(CD) AS MAX_CD
		<choose>
			<when test='grpCd != null and grpCd == "A"'>
		FROM TCHR_AUTO_HOMELOG_INFO
			</when>
			<otherwise>
		FROM TCHR_MANUAL_HOMELOG_INFO
			</otherwise>
		</choose>
		WHERE TCHR_ID = #{tchrId}
			AND YYMM = #{yymm};
	</select>
	
	<select id="spRegTchrManualHomelog" parameterType="hashMap" resultType="resultMap">
		/* Homelog.spRegTchrManualHomelog */
		{call es_s_dashboard.reg_homelog (
			  #{tchrId, mode=IN, jdbcType=INTEGER},
			  #{yymm, mode=IN, jdbcType=INTEGER},
			  #{yymmdd, mode=IN, jdbcType=INTEGER},
			  #{cd, mode=IN, jdbcType=INTEGER},
			  #{memo, mode=IN, jdbcType=VARCHAR},
			  #{name, mode=IN, jdbcType=VARCHAR},
			  #{propertyName, mode=IN, jdbcType=VARCHAR},
			  #{propertyContent, mode=IN, jdbcType=VARCHAR},
			  #{periodName, mode=IN, jdbcType=VARCHAR},
			  #{startPeriod, mode=IN, jdbcType=VARCHAR},
			  #{endPeriod, mode=IN, jdbcType=VARCHAR},
			  #{cont, mode=IN, jdbcType=VARCHAR},
			  #{templateCd, mode=IN, jdbcType=VARCHAR}
		 )}
	</select>
	
	<insert id="regHomelog" parameterType="hashMap">
		/* Homelog.regHomelog */
		<choose>
			<when test='grpCd != null and grpCd == "A"'>
		INSERT INTO TCHR_AUTO_HOMELOG_INFO
			</when>
			<otherwise>
		INSERT INTO TCHR_MANUAL_HOMELOG_INFO
			</otherwise>
		</choose>
		(
			TCHR_ID,
			YYMM,
			DT,
			CD,
			NAME,
			MEMO,
			PROPERTY_NM,
			PROPERTY_CONT,
			PERIOD_NM,
			PERIOD_STT_DT,
			PERIOD_END_DT,
			CONT,
			TEMPLATE_CD,
			REG_DTTM
		)
		VALUES
		(
			#{tchrId},
			#{yymm},
			#{yymmdd},
			#{cd},
			#{name},
			#{memo},
			#{propertyName},
			#{propertyContent},
			#{periodName},
			#{startPeriod},
			#{endPeriod},
			#{cont},
			#{templateCd},
			DATE_ADD(NOW(), INTERVAL 9 HOUR)
		)
		ON DUPLICATE KEY UPDATE 
			NAME=#{name},
			MEMO = #{memo},
			PROPERTY_NM = #{propertyName},
			PROPERTY_CONT = #{propertyContent},
			PERIOD_NM = #{periodName},
			PERIOD_STT_DT=#{startPeriod}, 
			PERIOD_END_DT = #{endPeriod},
			CONT = #{cont},
			TEMPLATE_CD = #{templateCd},
			UPD_DTTM = DATE_ADD(NOW(), INTERVAL 9 HOUR);
	</insert>
	
	<insert id="setHomelog" parameterType="hashMap">
		/* Homelog.setHomelog */
		INSERT INTO STUD_MANUAL_HOMELOG
		(
			STUD_ID,
		    DT,
		    CD,
		    YYYY,
		    STATUS,
		    PRST_DT,
		    TCHR_ID,
		    REG_DTTM
		)
		VALUES
		<foreach item="item" index="index" collection="list" separator=",">
			(#{item.studId}, #{item.dt}, #{item.cd}, #{item.yyyy}, #{item.status}, #{item.dt}, #{item.tchrId}, DATE_ADD(NOW(), INTERVAL 9 HOUR))       
		</foreach>
	</insert>
	
	<select id="spDelTchrManualHomelog" parameterType="hashMap" resultType="resultMap">
		/* Homelog.spDelTchrManualHomelog */
		{call es_s_dashboard.del_homelog (
			  #{tchrId, mode=IN, jdbcType=INTEGER},
			  #{cd, mode=IN, jdbcType=INTEGER}
		 )}
	</select>
	
	<update id="delHomelog" parameterType="hashMap">
		/* Homelog.delHomelog */
		UPDATE TCHR_MANUAL_HOMELOG_INFO 
		SET DELETE_CHECK = 'Y',
			UPD_DTTM = DATE_ADD(NOW(), INTERVAL 9 HOUR),
	        DEL_DTTM = DATE_ADD(NOW(), INTERVAL 9 HOUR)
		WHERE TCHR_ID = #{tchrId}
			AND CD = #{cd};
	</update>
	
</mapper>
	